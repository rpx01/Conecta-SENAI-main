<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recuperar Senha - Conecta SENAI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/brand.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet">
    <link href="/css/login.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid vh-100">
        <div class="row h-100">
            <div class="col-md-6 login-branding-col d-none d-md-flex align-items-center justify-content-center">
                <div class="text-center text-white">
                    <img src="/img/senai-logo.png" alt="SENAI Logo" style="width: 150px; margin-bottom: 2rem;">
                    <h2 class="display-4 fw-bold">Conecta SENAI</h2>
                    <p class="lead">A sua plataforma integrada de gestão e agendamentos.</p>
                </div>
            </div>

            <div class="col-md-6 d-flex align-items-center justify-content-center bg-light">
                <div class="login-form-container">
                    <div class="text-center mb-5 d-md-none">
                        <img src="/img/senai-logo.png" alt="SENAI Logo" style="width: 120px;">
                    </div>

                    {% with messages = get_flashed_messages() %}
                        {% if messages %}
                            <div class="alert alert-info">
                                {% for message in messages %}
                                    <div>{{ message }}</div>
                                {% endfor %}
                            </div>
                        {% elif request.args.get('sent') %}
                            <div class="alert alert-info">
                                Se o e-mail estiver cadastrado, enviaremos instruções de redefinição.
                            </div>
                        {% endif %}
                    {% endwith %}

                    <h1 class="h3 mb-3 fw-normal">Recuperar Senha</h1>
                    <p class="text-muted mb-4">Insira seu e-mail para receber as instruções de redefinição.</p>

                    <form id="forgotForm" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                        <div class="form-floating mb-3">
                            <input type="email" class="form-control" id="email" name="email" placeholder="seu@email.com" required>
                            <label for="email"><i class="bi bi-envelope me-2"></i>Email</label>
                        </div>
                        <div class="d-grid">
                            <button id="submitBtn" type="submit" class="btn btn-primary btn-lg" disabled>Enviar Link de Recuperação</button>
                        </div>
                        <div id="feedback" class="alert mt-3 d-none" role="alert"></div>
                    </form>

                    <div class="text-center mt-4">
                        <a href="{{ url_for('static', filename='admin/login.html') }}">Voltar ao login</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="mt-5 py-3 bg-dark text-white text-center">
        <div class="container">
            <p class="mb-0">Sistema FIEMG | O futuro se faz juntos.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('forgotForm');
            if (!form) return;
            const btn = document.getElementById('submitBtn');
            const feedback = document.getElementById('feedback');
            const emailInput = document.getElementById('email');

            const toggleButtonState = () => {
                btn.disabled = !emailInput.value.trim();
            };

            emailInput.addEventListener('input', toggleButtonState);
            toggleButtonState();

            form.addEventListener('submit', async function (e) {
                e.preventDefault();
                btn.disabled = true;
                feedback.classList.add('d-none');
                feedback.classList.remove('alert-info', 'alert-danger');

                try {
                    const formData = new FormData(form);
                    const resp = await fetch('/forgot', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await resp.json();
                    if (!resp.ok || !data.ok) {
                        throw new Error(data.message || 'Erro ao enviar.');
                    }

                    feedback.textContent = data.message || 'Se o e-mail existir, enviaremos as instruções.';
                    feedback.classList.remove('d-none');
                    feedback.classList.add('alert', 'alert-info');
                    setTimeout(() => {
                        window.location.href = '/admin/login.html';
                    }, 3000);
                } catch (err) {
                    feedback.textContent = err.message || 'Erro ao enviar o link de recuperação.';
                    feedback.classList.remove('d-none');
                    feedback.classList.add('alert', 'alert-danger');
                    btn.disabled = false;
                }
            });
        });
    </script>
</body>
</html>
